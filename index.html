<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hiragana Bloom</title>
    <style>
        /* All your existing CSS remains the same */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ffeef8 0%, #ffe5f1 50%, #ffd6ea 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 8px 30px rgba(255, 105, 180, 0.15);
        }

        .header h1 {
            font-size: 2.5em;
            color: #e91e63;
            margin-bottom: 5px;
        }

        .header p {
            color: #f48fb1;
            font-size: 1.1em;
        }

        .card {
            background: white;
            border-radius: 25px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 30px rgba(255, 105, 180, 0.15);
        }

        .section-title {
            font-size: 1.3em;
            color: #e91e63;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .column-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .column-card {
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%);
            border: 3px solid transparent;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .column-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(233, 30, 99, 0.3);
            border-color: #e91e63;
        }

        .column-card .char {
            font-size: 2.5em;
            color: #e91e63;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .column-card .name {
            color: #c2185b;
            font-weight: 600;
            font-size: 0.85em;
        }

        .column-card .count {
            color: #f06292;
            font-size: 0.75em;
            margin-top: 5px;
        }

        .column-card .progress-mini {
            width: 100%;
            height: 6px;
            background: rgba(233, 30, 99, 0.2);
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .column-card .progress-mini-fill {
            height: 100%;
            background: #e91e63;
            transition: width 0.3s ease;
        }

        .column-card .progress-text {
            color: #e91e63;
            font-size: 0.75em;
            margin-top: 5px;
            font-weight: bold;
        }

        .column-card .completion-badge {
            background: #4caf50;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7em;
            margin-top: 8px;
            display: inline-block;
        }

        .practice-all {
            background: linear-gradient(135deg, #ff6090 0%, #e91e63 100%);
            grid-column: 1 / -1;
            padding: 30px;
            color: white;
        }

        .practice-all .char {
            color: white;
        }

        .practice-all .name {
            color: white;
            font-size: 1.1em;
        }

        .practice-all .count {
            color: rgba(255,255,255,0.9);
        }

        .btn {
            background: linear-gradient(135deg, #ff6090 0%, #e91e63 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            width: 100%;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(233, 30, 99, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #e91e63;
            border: 2px solid #e91e63;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .walkthrough-container {
            text-align: center;
            padding: 20px;
        }

        .walkthrough-char {
            font-size: 8em;
            color: #e91e63;
            margin: 20px 0;
            font-weight: bold;
        }

        .walkthrough-romaji {
            font-size: 2.5em;
            color: #f06292;
            font-weight: bold;
            margin: 15px 0;
        }

        .walkthrough-tip {
            font-size: 1.1em;
            color: #666;
            margin: 20px 0;
            padding: 15px;
            background: #fce4ec;
            border-radius: 15px;
        }

        .audio-btn {
            background: linear-gradient(135deg, #ff6090 0%, #e91e63 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 12px;
            font-size: 1em;
            cursor: pointer;
            margin: 10px 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.3);
        }

        .audio-btn:hover {
            transform: scale(1.05);
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #fce4ec;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6090 0%, #e91e63 100%);
            transition: width 0.3s ease;
        }

        .quiz-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            color: #c2185b;
            font-weight: 600;
        }

        .difficulty-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .difficulty-btn {
            background: white;
            color: #e91e63;
            border: 3px solid #f8bbd0;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1em;
        }

        .difficulty-btn:hover {
            border-color: #e91e63;
            transform: translateY(-2px);
        }

        .difficulty-btn.active {
            background: linear-gradient(135deg, #ff6090 0%, #e91e63 100%);
            color: white;
            border-color: #e91e63;
        }

        .column-selector {
            background: #fce4ec;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .column-selector h4 {
            color: #e91e63;
            margin-bottom: 15px;
            text-align: center;
        }

        .column-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-label:hover {
            background: #fff0f5;
            transform: translateX(5px);
        }

        .checkbox-label input {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            cursor: pointer;
        }

        .quiz-char {
            font-size: 7em;
            color: #e91e63;
            margin: 30px 0;
            font-weight: bold;
        }

        input[type="text"] {
            width: 100%;
            padding: 18px;
            font-size: 1.6em;
            border: 3px solid #f8bbd0;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #e91e63;
            box-shadow: 0 0 20px rgba(233, 30, 99, 0.3);
        }

        .feedback {
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            font-size: 1.4em;
            font-weight: bold;
            text-align: center;
        }

        .feedback.correct {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .feedback.wrong {
            background: #ffcdd2;
            color: #c62828;
        }

        .results {
            text-align: center;
        }

        .trophy {
            font-size: 5em;
            margin: 20px 0;
        }

        .score {
            font-size: 3.5em;
            color: #e91e63;
            font-weight: bold;
            margin: 20px 0;
        }

        .hidden {
            display: none;
        }

        .mix-option {
            background: #fce4ec;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
        }

        .mix-option label {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 600;
            color: #e91e63;
        }

        .mix-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .quiz-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quiz-option {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: white;
            border: 3px solid #f8bbd0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .quiz-option:hover {
            border-color: #e91e63;
            transform: translateY(-2px);
        }

        .quiz-option.active {
            background: linear-gradient(135deg, #ff6090 0%, #e91e63 100%);
            color: white;
            border-color: #e91e63;
        }

        @media (max-width: 768px) {
            .difficulty-buttons {
                grid-template-columns: 1fr;
            }
            .walkthrough-char {
                font-size: 5em;
            }
            .quiz-char {
                font-size: 4em;
            }
            .quiz-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Menu Screen -->
        <div id="menu-screen">
            <div class="header">
                <h1>üå∏ Hiragana Bloom üå∏</h1>
                <p>Nurture your Japanese journey</p>
            </div>

            <div class="card">
                <div class="section-title">Learning Modules</div>
                <div class="column-grid" id="column-grid"></div>
            </div>
        </div>

        <!-- Study Screen -->
        <div id="study-screen" class="hidden">
            <div class="card">
                <button class="btn btn-secondary" onclick="backToMenu()">üè† Back to Menu</button>
            </div>

            <div class="card">
                <div class="section-title">üìö Character Walkthrough</div>
                <div class="quiz-info">
                    <span id="walkthrough-progress">Character 1 of 5</span>
                    <span id="walkthrough-column"></span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="walkthrough-progress-fill"></div>
                </div>

                <div class="walkthrough-container">
                    <div class="walkthrough-char" id="walkthrough-char">„ÅÇ</div>
                    <div class="walkthrough-romaji" id="walkthrough-romaji">a</div>
                    <button class="audio-btn" onclick="speakCharacter()">
                        üîä Listen to pronunciation
                    </button>
                    <div class="walkthrough-tip" id="walkthrough-tip">
                        This character represents the sound "a" as in "father"
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-secondary" id="prev-btn" onclick="previousChar()" style="flex: 1;">‚óÄ Previous</button>
                        <button class="btn" id="next-btn" onclick="nextChar()" style="flex: 1;">Next ‚ñ∂</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="section-title">üéØ Quiz Settings</div>
                
                <div class="difficulty-buttons">
                    <button class="difficulty-btn easy active" onclick="selectDifficulty('easy')">
                        üòä Easy<br><small>Single Characters</small>
                    </button>
                    <button class="difficulty-btn medium" onclick="selectDifficulty('medium')">
                        üòê Medium<br><small>2-Character Words</small>
                    </button>
                    <button class="difficulty-btn hard" onclick="selectDifficulty('hard')">
                        üò§ Hard<br><small>3-Character Words</small>
                    </button>
                    <button class="difficulty-btn sentence" onclick="selectDifficulty('sentence')">
                        üìù Sentences<br><small>Full Sentences</small>
                    </button>
                </div>

                <div class="quiz-options">
                    <div class="quiz-option active" id="finite-mode" onclick="selectQuizMode('finite')">
                        üìä Finite Quiz<br><small>15 questions</small>
                    </div>
                    <div class="quiz-option" id="infinite-mode" onclick="selectQuizMode('infinite')">
                        ‚àû Infinite Quiz<br><small>Keep going!</small>
                    </div>
                </div>

                <div id="mix-option" class="mix-option hidden">
                    <label>
                        <input type="checkbox" id="mix-columns-checkbox">
                        Mix with other hiragana columns
                    </label>
                </div>

                <div id="column-selector" class="column-selector hidden">
                    <h4>Select columns to mix:</h4>
                    <div class="column-checkboxes" id="column-checkboxes"></div>
                </div>

                <button class="btn" onclick="startQuiz()">üéØ Start Quiz</button>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden">
            <div class="card">
                <div class="quiz-info">
                    <span id="question-num">Question 1 of 15</span>
                    <span id="score-display">Score: 0/15</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>

            <div class="card">
                <div style="text-align: center;">
                    <div class="quiz-char" id="quiz-char">„ÅÇ</div>
                    <button class="audio-btn" onclick="speakQuizCharacter()">
                        üîä Listen
                    </button>
                    <input type="text" id="answer-input" placeholder="Type the romaji..." autocomplete="off">
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn" id="submit-btn" onclick="submitAnswer()" style="flex: 1;">Submit</button>
                        <button class="btn btn-secondary" id="reveal-btn" onclick="revealAnswer()" style="flex: 1;">üëÅÔ∏è Reveal</button>
                    </div>
                    <div id="feedback"></div>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="hidden">
            <div class="card results">
                <div class="trophy">üèÜ</div>
                <h2 style="color: #e91e63; font-size: 2em; margin-bottom: 20px;">Quiz Complete!</h2>
                <div class="score" id="final-score">0/0</div>
                <div style="font-size: 1.5em; color: #666; margin-bottom: 30px;" id="final-percentage">0% Correct</div>
                <button class="btn" onclick="retryQuiz()" style="margin-bottom: 15px;">üîÑ Try Again</button>
                <button class="btn btn-secondary" onclick="backToMenu()">üè† Back to Menu</button>
            </div>
        </div>
    </div>

    <script>
        const HIRAGANA = {
            a: { name: 'Vowels („ÅÇË°å)', chars: [
                ['„ÅÇ', 'a', 'Pronounced like "a" in "father"'],
                ['„ÅÑ', 'i', 'Pronounced like "ee" in "see"'],
                ['„ÅÜ', 'u', 'Pronounced like "oo" in "food"'],
                ['„Åà', 'e', 'Pronounced like "e" in "bed"'],
                ['„Åä', 'o', 'Pronounced like "o" in "go"']
            ]},
            k: { name: 'K Column („ÅãË°å)', chars: [
                ['„Åã', 'ka', 'Like "ka" in "car"'],
                ['„Åç', 'ki', 'Like "key"'],
                ['„Åè', 'ku', 'Like "coo"'],
                ['„Åë', 'ke', 'Like "keh" in "kept"'],
                ['„Åì', 'ko', 'Like "co" in "code"']
            ]},
            s: { name: 'S Column („ÅïË°å)', chars: [
                ['„Åï', 'sa', 'Like "sa" in "saw"'],
                ['„Åó', 'shi', 'Like "she"'],
                ['„Åô', 'su', 'Like "sue"'],
                ['„Åõ', 'se', 'Like "se" in "set"'],
                ['„Åù', 'so', 'Like "so" in "soap"']
            ]},
            t: { name: 'T Column („ÅüË°å)', chars: [
                ['„Åü', 'ta', 'Like "ta" in "taco"'],
                ['„Å°', 'chi', 'Like "chee" in "cheese"'],
                ['„Å§', 'tsu', 'Like "tsunami" (with a T sound before su)'],
                ['„Å¶', 'te', 'Like "te" in "tennis"'],
                ['„Å®', 'to', 'Like "toe"']
            ]},
            n: { name: 'N Column („Å™Ë°å)', chars: [
                ['„Å™', 'na', 'Like "na" in "na na na"'],
                ['„Å´', 'ni', 'Like "knee"'],
                ['„Å¨', 'nu', 'Like "new"'],
                ['„Å≠', 'ne', 'Like "ne" in "net"'],
                ['„ÅÆ', 'no', 'Like "no"']
            ]},
            h: { name: 'H Column („ÅØË°å)', chars: [
                ['„ÅØ', 'ha', 'Like "ha" in "haha"'],
                ['„Å≤', 'hi', 'Like "he" in "heat"'],
                ['„Åµ', 'fu', 'Like blowing out a candle, not "foo"'],
                ['„Å∏', 'he', 'Like "he" in "hen"'],
                ['„Åª', 'ho', 'Like "ho" in "hope"']
            ]},
            m: { name: 'M Column („ÅæË°å)', chars: [
                ['„Åæ', 'ma', 'Like "ma" in "mama"'],
                ['„Åø', 'mi', 'Like "me"'],
                ['„ÇÄ', 'mu', 'Like "moo"'],
                ['„ÇÅ', 'me', 'Like "me" in "men"'],
                ['„ÇÇ', 'mo', 'Like "mo" in "most"']
            ]},
            y: { name: 'Y Column („ÇÑË°å)', chars: [
                ['„ÇÑ', 'ya', 'Like "ya" in "yacht"'],
                ['„ÇÜ', 'yu', 'Like "you"'],
                ['„Çà', 'yo', 'Like "yo"']
            ]},
            r: { name: 'R Column („ÇâË°å)', chars: [
                ['„Çâ', 'ra', 'Between "ra" and "la"'],
                ['„Çä', 'ri', 'Between "ree" and "lee"'],
                ['„Çã', 'ru', 'Between "roo" and "loo"'],
                ['„Çå', 're', 'Between "re" and "le" in "red"'],
                ['„Çç', 'ro', 'Between "ro" and "lo"']
            ]},
            w: { name: 'W Column („ÇèË°å)', chars: [
                ['„Çè', 'wa', 'Like "wa" in "water"'],
                ['„Çí', 'wo', 'Pronounced like "o" (particle)'],
                ['„Çì', 'n', 'Like "n" in "sing" (nasal sound)']
            ]}
        };

        const VOWEL_WORDS = {
            medium: [
                ['„ÅÇ„ÅÑ', 'ai'], ['„ÅÑ„ÅÜ', 'iu'], ['„ÅÜ„Åà', 'ue'], ['„Åà„ÅÑ', 'ei'], 
                ['„Åä„ÅÑ', 'oi'], ['„ÅÑ„Åà', 'ie'], ['„ÅÇ„Åä', 'ao'], ['„ÅÜ„Åä', 'uo'], 
                ['„Åä„ÅÜ', 'ou'], ['„Åà„Åà', 'ee']
            ],
            hard: [
                ['„ÅÇ„Åä„ÅÑ', 'aoi'], ['„ÅÑ„ÅÜ„Åà', 'iue'], ['„Åä„ÅÑ„Åä„ÅÑ', 'oioi'], 
                ['„ÅÇ„ÅÑ„ÅÜ', 'aiu'], ['„ÅÜ„Åà„Åä', 'ueo'], ['„Åä„ÅÜ„Åà„Çì', 'ouen'], 
                ['„ÅÇ„Åà„Çì', 'aen'], ['„ÅÑ„ÅÜ„Çì', 'iun'], ['„Åä„Åä„ÅÑ', 'ooi'], ['„Åà„Åà„ÅÑ', 'eei']
            ]
        };

        // Sentence mode data
        const SENTENCES = [
            ['„Åì„Çì„Å´„Å°„ÅØ', 'konnichiwa', 'Hello'],
            ['„ÅÇ„Çä„Åå„Å®„ÅÜ', 'arigatou', 'Thank you'],
            ['„Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô', 'ohayou gozaimasu', 'Good morning'],
            ['„Åï„Çà„ÅÜ„Å™„Çâ', 'sayounara', 'Goodbye'],
            ['„Åä„ÇÑ„Åô„Åø„Å™„Åï„ÅÑ', 'oyasumi nasai', 'Good night'],
            ['„Åô„Åø„Åæ„Åõ„Çì', 'sumimasen', 'Excuse me / I\'m sorry'],
            ['„Åä„Å≠„Åå„ÅÑ„Åó„Åæ„Åô', 'onegaishimasu', 'Please'],
            ['„ÅØ„ÅÑ', 'hai', 'Yes'],
            ['„ÅÑ„ÅÑ„Åà', 'iie', 'No'],
            ['„ÅØ„Åò„ÇÅ„Åæ„Åó„Å¶', 'hajimemashite', 'Nice to meet you'],
            ['„Åä„Åí„Çì„Åç„Åß„Åô„Åã', 'ogenki desu ka', 'How are you?'],
            ['„Åí„Çì„Åç„Åß„Åô', 'genki desu', 'I\'m fine'],
            ['„Çè„Åü„Åó„ÅÆ„Å™„Åæ„Åà„ÅØ', 'watashi no namae wa', 'My name is'],
            ['„Å´„Åª„Çì„Åî', 'nihongo', 'Japanese language'],
            ['„Åà„ÅÑ„Åî', 'eigo', 'English'],
            ['„Å®„ÇÇ„Å†„Å°', 'tomodachi', 'Friend'],
            ['„Å†„ÅÑ„Åô„Åç', 'daisuki', 'I love it'],
            ['„Åü„Åπ„ÇÇ„ÅÆ', 'tabemono', 'Food'],
            ['„ÅÆ„Åø„ÇÇ„ÅÆ', 'nomimono', 'Drink'],
            ['„Åä„ÅÑ„Åó„ÅÑ', 'oishii', 'Delicious']
        ];

        let currentColumn = null;
        let currentDifficulty = 'easy';
        let quizMode = 'finite'; // 'finite' or 'infinite'
        let quizData = [];
        let currentQuestion = 0;
        let score = 0;
        let walkthroughChars = [];
        let walkthroughIndex = 0;
        let columnProgress = {};
        let selectedColumns = new Set();

        function getAllChars() {
            let all = [];
            Object.values(HIRAGANA).forEach(col => {
                col.chars.forEach(char => all.push([char[0], char[1]]));
            });
            return all;
        }

        function speakCharacter() {
            const romaji = document.getElementById('walkthrough-romaji').textContent;
            const utterance = new SpeechSynthesisUtterance(romaji);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.7;
            speechSynthesis.speak(utterance);
        }

        function speakQuizCharacter() {
            const [char, romaji] = quizData[currentQuestion];
            const utterance = new SpeechSynthesisUtterance(romaji);
            utterance.lang = 'ja-JP';
            utterance.rate = 0.7;
            speechSynthesis.speak(utterance);
        }

        function loadProgress() {
            const saved = localStorage.getItem('hiragana_progress');
            if (saved) {
                columnProgress = JSON.parse(saved);
            } else {
                Object.keys(HIRAGANA).forEach(key => {
                    columnProgress[key] = { easy: 0, medium: 0, hard: 0, sentence: 0 };
                });
                columnProgress['all'] = { easy: 0, medium: 0, hard: 0, sentence: 0 };
            }
        }

        function saveProgress() {
            localStorage.setItem('hiragana_progress', JSON.stringify(columnProgress));
        }

        function updateColumnProgress(column, difficulty, percentage) {
            if (!columnProgress[column]) {
                columnProgress[column] = { easy: 0, medium: 0, hard: 0, sentence: 0 };
            }
            if (percentage > columnProgress[column][difficulty]) {
                columnProgress[column][difficulty] = percentage;
                saveProgress();
            }
        }

        function getColumnCompletion(column) {
            if (!columnProgress[column]) return 0;
            const prog = columnProgress[column];
            return Math.round((prog.easy + prog.medium + prog.hard + prog.sentence) / 4);
        }

        function getRandomChar(chars) {
            return chars[Math.floor(Math.random() * chars.length)];
        }

        function generateRandomWords(baseChars, allChars, count, wordLength) {
            const words = [];
            const usedWords = new Set();
            
            for (let i = 0; i < count * 3 && words.length < count; i++) {
                let chars = [];
                let romaji = [];
                
                const firstChar = getRandomChar(baseChars);
                chars.push(firstChar[0]);
                romaji.push(firstChar[1]);
                
                for (let j = 1; j < wordLength; j++) {
                    const randomChar = getRandomChar(allChars);
                    chars.push(randomChar[0]);
                    romaji.push(randomChar[1]);
                }
                
                const word = chars.join('');
                const reading = romaji.join('');
                
                if (!usedWords.has(word)) {
                    words.push([word, reading]);
                    usedWords.add(word);
                }
            }
            
            return words;
        }

        function getSelectedColumnsChars() {
            let chars = [];
            selectedColumns.forEach(key => {
                HIRAGANA[key].chars.forEach(char => {
                    chars.push([char[0], char[1]]);
                });
            });
            return chars;
        }

        function generateWords(columnKey, difficulty) {
            let words = [];
            const mixWithOthers = document.getElementById('mix-columns-checkbox').checked;
            
            if (difficulty === 'sentence') {
                // For sentence mode, use predefined sentences
                words = [...SENTENCES];
            } else if (columnKey === 'a') {
                if (difficulty === 'easy') {
                    words = HIRAGANA[columnKey].chars.map(c => [c[0], c[1]]);
                } else if (difficulty === 'medium') {
                    words = [...VOWEL_WORDS.medium];
                } else if (difficulty === 'hard') {
                    words = [...VOWEL_WORDS.hard];
                }
            } else {
                if (difficulty === 'easy') {
                    if (columnKey === 'all') {
                        words = getAllChars();
                    } else {
                        words = HIRAGANA[columnKey].chars.map(c => [c[0], c[1]]);
                    }
                } else if (difficulty === 'medium' || difficulty === 'hard') {
                    const wordLength = difficulty === 'medium' ? 2 : 3;
                    const columnChars = columnKey === 'all' ? getAllChars() : HIRAGANA[columnKey].chars.map(c => [c[0], c[1]]);
                    
                    let availableChars;
                    if (mixWithOthers && selectedColumns.size > 0) {
                        availableChars = getSelectedColumnsChars();
                    } else if (mixWithOthers) {
                        availableChars = getAllChars();
                    } else {
                        availableChars = columnChars;
                    }
                    
                    words = generateRandomWords(columnChars, availableChars, 30, wordLength);
                }
            }
            
            return words;
        }

        function initMenu() {
            loadProgress();
            const grid = document.getElementById('column-grid');
            grid.innerHTML = '';

            Object.entries(HIRAGANA).forEach(([key, data]) => {
                const completion = getColumnCompletion(key);
                const card = document.createElement('div');
                card.className = 'column-card';
                card.onclick = () => startStudy(key);
                
                let completionHTML = '';
                if (completion > 0) {
                    if (completion === 100) {
                        completionHTML = '<div class="completion-badge">‚úì Complete</div>';
                    } else {
                        completionHTML = `
                            <div class="progress-mini">
                                <div class="progress-mini-fill" style="width: ${completion}%"></div>
                            </div>
                            <div class="progress-text">${completion}% Complete</div>
                        `;
                    }
                }
                
                card.innerHTML = `
                    <div class="char">${data.chars[0][0]}</div>
                    <div class="name">${data.name}</div>
                    <div class="count">${data.chars.length} characters</div>
                    ${completionHTML}
                `;
                grid.appendChild(card);
            });

            const allCompletion = getColumnCompletion('all');
            const allCard = document.createElement('div');
            allCard.className = 'column-card practice-all';
            allCard.onclick = () => startStudy('all');
            
            let allCompletionHTML = '';
            if (allCompletion > 0) {
                if (allCompletion === 100) {
                    allCompletionHTML = '<div class="completion-badge">‚úì Mastered!</div>';
                } else {
                    allCompletionHTML = `
                        <div class="progress-mini">
                            <div class="progress-mini-fill" style="width: ${allCompletion}%"></div>
                        </div>
                        <div class="progress-text">${allCompletion}% Complete</div>
                    `;
                }
            }
            
            allCard.innerHTML = `
                <div class="char">‚ú®</div>
                <div class="name">Practice All Columns</div>
                <div class="count">Master 46 hiragana!</div>
                ${allCompletionHTML}
            `;
            grid.appendChild(allCard);
        }

        function showScreen(screenId) {
            document.querySelectorAll('[id$="-screen"]').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        function selectDifficulty(level) {
            currentDifficulty = level;
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.difficulty-btn').classList.add('active');
            
            const mixOption = document.getElementById('mix-option');
            const columnSelector = document.getElementById('column-selector');
            
            if (level === 'medium' || level === 'hard') {
                mixOption.classList.remove('hidden');
                if (document.getElementById('mix-columns-checkbox').checked) {
                    columnSelector.classList.remove('hidden');
                }
            } else {
                mixOption.classList.add('hidden');
                columnSelector.classList.add('hidden');
            }
        }

        function selectQuizMode(mode) {
            quizMode = mode;
            document.querySelectorAll('.quiz-option').forEach(option => {
                option.classList.remove('active');
            });
            document.getElementById(`${mode}-mode`).classList.add('active');
        }

        function startStudy(column) {
            currentColumn = column;
            currentDifficulty = 'easy';
            quizMode = 'finite';
            walkthroughIndex = 0;
            selectedColumns.clear();
            showScreen('study-screen');

            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.difficulty-btn.easy').classList.add('active');

            document.querySelectorAll('.quiz-option').forEach(option => {
                option.classList.remove('active');
            });
            document.getElementById('finite-mode').classList.add('active');

            if (column === 'all') {
                walkthroughChars = getAllChars().map(c => [...c, 'Practice this character']);
            } else {
                walkthroughChars = HIRAGANA[column].chars;
                document.getElementById('walkthrough-column').textContent = HIRAGANA[column].name;
            }

            updateWalkthrough();
            setupColumnSelector();
        }

        function setupColumnSelector() {
            const container = document.getElementById('column-checkboxes');
            container.innerHTML = '';
            
            Object.entries(HIRAGANA).forEach(([key, data]) => {
                const label = document.createElement('label');
                label.className = 'checkbox-label';
                label.innerHTML = `
                    <input type="checkbox" value="${key}" onchange="toggleColumn('${key}')">
                    <span>${data.name.split('(')[0]}</span>
                `;
                container.appendChild(label);
            });

            document.getElementById('mix-columns-checkbox').onchange = function() {
                const selector = document.getElementById('column-selector');
                if (this.checked && (currentDifficulty === 'medium' || currentDifficulty === 'hard')) {
                    selector.classList.remove('hidden');
                } else {
                    selector.classList.add('hidden');
                }
            };
        }

        function toggleColumn(key) {
            if (selectedColumns.has(key)) {
                selectedColumns.delete(key);
            } else {
                selectedColumns.add(key);
            }
        }

        function updateWalkthrough() {
            const [char, romaji, tip] = walkthroughChars[walkthroughIndex];
            
            document.getElementById('walkthrough-char').textContent = char;
            document.getElementById('walkthrough-romaji').textContent = romaji;
            document.getElementById('walkthrough-tip').textContent = tip;
            document.getElementById('walkthrough-progress').textContent = 
                `Character ${walkthroughIndex + 1} of ${walkthroughChars.length}`;
            document.getElementById('walkthrough-progress-fill').style.width = 
                `${((walkthroughIndex + 1) / walkthroughChars.length) * 100}%`;

            document.getElementById('prev-btn').disabled = walkthroughIndex === 0;
            document.getElementById('next-btn').textContent = 
                walkthroughIndex === walkthroughChars.length - 1 ? 'üéâ Complete' : 'Next ‚ñ∂';
        }

        function previousChar() {
            if (walkthroughIndex > 0) {
                walkthroughIndex--;
                updateWalkthrough();
            }
        }

        function nextChar() {
            if (walkthroughIndex < walkthroughChars.length - 1) {
                walkthroughIndex++;
                updateWalkthrough();
            } else {
                document.querySelector('.section-title').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }
        }

        function startQuiz() {
            const words = generateWords(currentColumn, currentDifficulty);
            
            if (quizMode === 'finite') {
                // For finite mode, shuffle and take 15 questions
                quizData = [...words].sort(() => Math.random() - 0.5).slice(0, 15);
            } else {
                // For infinite mode, we'll generate questions on the fly
                // Start with a shuffled set of 15, then generate more as needed
                quizData = [...words].sort(() => Math.random() - 0.5).slice(0, 15);
            }
            
            currentQuestion = 0;
            score = 0;

            showScreen('quiz-screen');
            updateQuiz();
        }

        function updateQuiz() {
            if (quizMode === 'finite') {
                document.getElementById('question-num').textContent = 
                    `Question ${currentQuestion + 1} of ${quizData.length}`;
            } else {
                document.getElementById('question-num').textContent = 
                    `Question ${currentQuestion + 1} (‚àû)`;
            }
            
            document.getElementById('score-display').textContent = 
                `Score: ${score}/${currentQuestion}`;
            
            if (quizMode === 'finite') {
                document.getElementById('progress-fill').style.width = 
                    `${((currentQuestion + 1) / quizData.length) * 100}%`;
            } else {
                document.getElementById('progress-fill').style.width = 
                    `${((currentQuestion % 15) / 15) * 100}%`;
            }
            
            document.getElementById('quiz-char').textContent = quizData[currentQuestion][0];
            document.getElementById('answer-input').value = '';
            document.getElementById('answer-input').disabled = false;
            document.getElementById('submit-btn').disabled = false;
            document.getElementById('reveal-btn').disabled = false;
            document.getElementById('feedback').innerHTML = '';
            document.getElementById('answer-input').focus();
        }

        function revealAnswer() {
            const [char, correct] = quizData[currentQuestion];
            
            document.getElementById('answer-input').disabled = true;
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('reveal-btn').disabled = true;

            const feedback = document.getElementById('feedback');
            feedback.className = 'feedback wrong';
            feedback.innerHTML = `The answer is: <strong>${correct}</strong>`;

            setTimeout(() => {
                nextQuestion();
            }, 1500);
        }

        function submitAnswer() {
            const input = document.getElementById('answer-input');
            const answer = input.value.toLowerCase().trim();
            const [char, correct] = quizData[currentQuestion];
            const isCorrect = answer === correct;

            if (isCorrect) score++;

            input.disabled = true;
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('reveal-btn').disabled = true;

            const feedback = document.getElementById('feedback');
            feedback.className = `feedback ${isCorrect ? 'correct' : 'wrong'}`;
            feedback.innerHTML = isCorrect 
                ? '‚úì Correct!' 
                : `‚úó Wrong! The correct answer is: <strong>${correct}</strong>`;

            setTimeout(() => {
                nextQuestion();
            }, 1500);
        }

        function nextQuestion() {
            if (quizMode === 'finite') {
                if (currentQuestion + 1 < quizData.length) {
                    currentQuestion++;
                    updateQuiz();
                } else {
                    showResults();
                }
            } else {
                // Infinite mode - always continue
                currentQuestion++;
                
                // If we're running out of questions, generate more
                if (currentQuestion >= quizData.length - 5) {
                    const moreWords = generateWords(currentColumn, currentDifficulty);
                    quizData.push(...moreWords.sort(() => Math.random() - 0.5).slice(0, 10));
                }
                
                updateQuiz();
            }
        }

        function showResults() {
            showScreen('results-screen');
            const percentage = Math.round((score / quizData.length) * 100);
            document.getElementById('final-score').textContent = `${score}/${quizData.length}`;
            document.getElementById('final-percentage').textContent = `${percentage}% Correct`;
            
            updateColumnProgress(currentColumn, currentDifficulty, percentage);
        }

        function retryQuiz() {
            startQuiz();
        }

        function backToMenu() {
            showScreen('menu-screen');
            initMenu();
        }

        document.getElementById('answer-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !document.getElementById('submit-btn').disabled) {
                submitAnswer();
            }
        });

        initMenu();
    </script>
</body>
</html>
